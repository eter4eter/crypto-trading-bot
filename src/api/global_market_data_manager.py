"""
–ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ï–¥–∏–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π, –∫–æ—Ç–æ—Ä—ã–π:
1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑
2. –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π  
3. –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫–∏/polling –¥–ª—è –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–∞—Ä+frame
4. –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
"""

import asyncio
import time
from typing import Dict, Set, List, Callable, Tuple
from dataclasses import dataclass

from ..logger import logger
from ..config import StrategyConfig, SignalConfig
from .bybit_client import BybitClient
from .bybit_websocket_client import BybitWebSocketClient
from .common import Kline


@dataclass
class SubscriptionRequest:
    """–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏"""
    strategy_name: str
    symbol: str
    frame: str
    callback: Callable[[str, Kline], None]
    source_type: str  # "websocket" –∏–ª–∏ "polling"


class GlobalMarketDataManager:
    """
    –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Ä—ã–Ω–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
    
    –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç:
    - WebSocket –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –¥–ª—è –º–∏–Ω—É—Ç–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
    - REST polling –¥–ª—è —Å–µ–∫—É–Ω–¥–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤  
    - –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∑–∞–ø—Ä–æ—Å–æ–≤
    - –¢—Ä–∞–Ω—Å–ª—è—Ü–∏–µ–π –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    """
    
    def __init__(
        self,
        rest_client: BybitClient,
        ws_client: BybitWebSocketClient,
        market_category: str = "linear"
    ):
        self.rest_client = rest_client
        self.ws_client = ws_client
        self.market_category = market_category
        
        # –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
        self.subscriptions: Dict[Tuple[str, str], List[SubscriptionRequest]] = {}
        
        # –ê–∫—Ç–∏–≤–Ω—ã–µ WebSocket –ø–æ–¥–ø–∏—Å–∫–∏
        self.active_ws_subscriptions: Set[Tuple[str, str]] = set()
        
        # –ê–∫—Ç–∏–≤–Ω—ã–µ polling –∑–∞–¥–∞—á–∏ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É)
        self.polling_tasks: Dict[str, asyncio.Task] = {}
        self.polling_active = False
        self.last_poll_times: Dict[str, float] = {}
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
        self.registered_strategies: Set[str] = set()
        
        self.is_running = False
        
        logger.info("üåç GlobalMarketDataManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")

    def register_strategy(self, strategy_config: StrategyConfig, kline_callback: Callable[[str, Kline], None]):
        """
        –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –µ—ë –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç–µ–π –≤ –¥–∞–Ω–Ω—ã—Ö
        
        Args:
            strategy_config: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
            kline_callback: Callback –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è kline –¥–∞–Ω–Ω—ã—Ö
        """
        
        strategy_name = strategy_config.name
        
        if strategy_name in self.registered_strategies:
            logger.warning(f"[{strategy_name}] –°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞")
            return
        
        logger.info(f"[{strategy_name}] üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏...")
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–µ signals —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
        subscription_count = 0
        
        for signal_name, signal_config in strategy_config.signals.items():
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –ø–æ frame
            source_type = "polling" if signal_config.frame.endswith("s") else "websocket"
            
            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º index –ø–∞—Ä—É
            self._add_subscription(
                strategy_name=strategy_name,
                symbol=signal_config.index,
                frame=signal_config.frame,
                callback=kline_callback,
                source_type=source_type
            )\n            subscription_count += 1\n            \n            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ target –ø–∞—Ä—ã\n            for trade_pair in strategy_config.trade_pairs:\n                self._add_subscription(\n                    strategy_name=strategy_name,\n                    symbol=trade_pair,\n                    frame=signal_config.frame,\n                    callback=kline_callback,\n                    source_type=source_type\n                )\n                subscription_count += 1\n        \n        self.registered_strategies.add(strategy_name)\n        \n        logger.info(f"[{strategy_name}] ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ {subscription_count} –ø–æ–¥–ø–∏—Å–æ–∫\")\n        logger.info(f\"   Signals: {len(strategy_config.signals)}\")\n        logger.info(f\"   Trade pairs: {len(strategy_config.trade_pairs)}\")\n        \n        # –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏\n        if self.is_running:\n            asyncio.create_task(self._activate_new_subscriptions(strategy_name))\n\n    def _add_subscription(\n        self, \n        strategy_name: str,\n        symbol: str, \n        frame: str,\n        callback: Callable,\n        source_type: str\n    ):\n        \"\"\"–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ —Ä–µ–µ—Å—Ç—Ä\"\"\"\n        \n        key = (symbol, frame)\n        \n        subscription = SubscriptionRequest(\n            strategy_name=strategy_name,\n            symbol=symbol,\n            frame=frame,\n            callback=callback,\n            source_type=source_type\n        )\n        \n        if key not in self.subscriptions:\n            self.subscriptions[key] = []\n        \n        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ\n        existing = [s for s in self.subscriptions[key] if s.strategy_name == strategy_name]\n        if not existing:\n            self.subscriptions[key].append(subscription)\n            \n            logger.debug(\n                f\"   + {symbol} @ {frame} ({source_type}) -> [{strategy_name}]\"\n            )\n\n    async def start(self):\n        \"\"\"–ó–∞–ø—É—Å–∫ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö\"\"\"\n        \n        if self.is_running:\n            logger.warning(\"GlobalMarketDataManager —É–∂–µ –∑–∞–ø—É—â–µ–Ω\")\n            return\n        \n        logger.info(\"üöÄ –ó–∞–ø—É—Å–∫ GlobalMarketDataManager...\")\n        \n        # –ó–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø–æ–¥–ø–∏—Å–∫–∏\n        await self._start_websocket_subscriptions()\n        \n        # –ó–∞–ø—É—Å–∫–∞–µ–º polling –∑–∞–¥–∞—á–∏\n        await self._start_polling_tasks()\n        \n        self.is_running = True\n        \n        total_subscriptions = len(self.subscriptions)\n        polling_count = len([s for subs in self.subscriptions.values() \n                           for s in subs if s.source_type == \"polling\"])\n        websocket_count = total_subscriptions - polling_count\n        \n        logger.info(\"\")\n        logger.info(\"üåç ‚ïê‚ïê‚ïê GLOBAL MARKET DATA MANAGER ACTIVE ‚ïê‚ïê‚ïê\")\n        logger.info(f\"   Registered strategies: {len(self.registered_strategies)}\")\n        logger.info(f\"   Total subscriptions: {total_subscriptions}\")\n        logger.info(f\"   üì° Polling: {polling_count}\")\n        logger.info(f\"   üîå WebSocket: {websocket_count}\")\n        logger.info(f\"   Active WS subs: {len(self.active_ws_subscriptions)}\")\n        logger.info(f\"   Active polling tasks: {len(self.polling_tasks)}\")\n        logger.info(\"‚ïê\" * 70)\n        logger.info(\"\")\n\n    async def stop(self):\n        \"\"\"–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞\"\"\"\n        \n        logger.info(\"‚èπ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ GlobalMarketDataManager...\")\n        \n        self.is_running = False\n        \n        # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ polling –∑–∞–¥–∞—á–∏\n        await self._stop_polling_tasks()\n        \n        # –û—á–∏—â–∞–µ–º –ø–æ–¥–ø–∏—Å–∫–∏\n        self.subscriptions.clear()\n        self.active_ws_subscriptions.clear()\n        self.registered_strategies.clear()\n        \n        logger.info(\"‚úÖ GlobalMarketDataManager –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω\")\n\n    def unregister_strategy(self, strategy_name: str):\n        \"\"\"–û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\"\"\"\n        \n        if strategy_name not in self.registered_strategies:\n            return\n        \n        logger.info(f\"[{strategy_name}] üì§ –û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...\")\n        \n        # –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ —ç—Ç–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n        keys_to_remove = []\n        \n        for key, subscription_list in self.subscriptions.items():\n            # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫–∏, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π\n            self.subscriptions[key] = [\n                s for s in subscription_list if s.strategy_name != strategy_name\n            ]\n            \n            # –ï—Å–ª–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å, –ø–æ–º–µ—á–∞–µ–º –∫–ª—é—á –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è\n            if not self.subscriptions[key]:\n                keys_to_remove.append(key)\n        \n        # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ –∫–ª—é—á–∏\n        for key in keys_to_remove:\n            del self.subscriptions[key]\n            \n            # –ï—Å–ª–∏ –±—ã–ª–∞ WebSocket –ø–æ–¥–ø–∏—Å–∫–∞, –æ—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è\n            symbol, frame = key\n            if (symbol, frame) in self.active_ws_subscriptions:\n                # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—Ç–ø–∏—Å–∫—É –æ—Ç WebSocket\n                self.active_ws_subscriptions.remove((symbol, frame))\n        \n        self.registered_strategies.remove(strategy_name)\n        \n        logger.info(f\"[{strategy_name}] ‚úÖ –û—Ç–º–µ–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞\")\n\n    # ========== WebSocket Management ==========\n    \n    async def _start_websocket_subscriptions(self):\n        \"\"\"–ó–∞–ø—É—Å–∫ WebSocket –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –≤—Å–µ—Ö –º–∏–Ω—É—Ç–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤\"\"\"\n        \n        # –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ WebSocket –ø–æ–¥–ø–∏—Å–∫–∏\n        ws_subscriptions: Set[Tuple[str, str]] = set()\n        \n        for key, subscription_list in self.subscriptions.items():\n            symbol, frame = key\n            \n            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ —Ç—Ä–µ–±—É–µ—Ç WebSocket\n            has_websocket = any(s.source_type == \"websocket\" for s in subscription_list)\n            \n            if has_websocket:\n                ws_subscriptions.add((symbol, frame))\n        \n        if not ws_subscriptions:\n            logger.info(\"–ù–µ—Ç WebSocket –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏\")\n            return\n        \n        logger.info(f\"–ó–∞–ø—É—Å–∫ {len(ws_subscriptions)} WebSocket –ø–æ–¥–ø–∏—Å–æ–∫...\")\n        \n        for symbol, frame in ws_subscriptions:\n            try:\n                await self.ws_client.subscribe_kline(\n                    category=self.market_category,\n                    symbol=symbol,\n                    interval=frame,\n                    callback=self._ws_callback\n                )\n                \n                self.active_ws_subscriptions.add((symbol, frame))\n                logger.debug(f\"   ‚úì WS: {symbol} @ {frame}\")\n                \n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ WS –ø–æ–¥–ø–∏—Å–∫–∏ {symbol}@{frame}: {e}\")\n        \n        logger.info(f\"‚úÖ WebSocket: {len(self.active_ws_subscriptions)} –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫\")\n\n    async def _ws_callback(self, symbol: str, kline: Kline):\n        \"\"\"–ï–¥–∏–Ω—ã–π callback –¥–ª—è –≤—Å–µ—Ö WebSocket –¥–∞–Ω–Ω—ã—Ö\"\"\"\n        \n        if not kline.confirm:\n            return  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n        \n        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —ç—Ç–æ–π –ø–∞—Ä—ã –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ\n        matching_subscriptions = []\n        \n        for key, subscription_list in self.subscriptions.items():\n            sub_symbol, sub_frame = key\n            \n            if sub_symbol == symbol:\n                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ frame (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –¥–ª—è –æ–¥–Ω–æ–≥–æ symbol)\n                for subscription in subscription_list:\n                    if (subscription.source_type == \"websocket\" and \n                        subscription.frame == sub_frame):\n                        matching_subscriptions.append(subscription)\n        \n        # –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n        for subscription in matching_subscriptions:\n            try:\n                await subscription.callback(symbol, kline)\n            except Exception as e:\n                logger.error(\n                    f\"–û—à–∏–±–∫–∞ WS callback [{subscription.strategy_name}] {symbol}: {e}\"\n                )\n\n    # ========== Polling Management ==========\n    \n    async def _start_polling_tasks(self):\n        \"\"\"–ó–∞–ø—É—Å–∫ polling –∑–∞–¥–∞—á –¥–ª—è —Å–µ–∫—É–Ω–¥–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤\"\"\"\n        \n        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º polling –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º\n        polling_groups: Dict[str, List[SubscriptionRequest]] = {}\n        \n        for subscription_list in self.subscriptions.values():\n            for subscription in subscription_list:\n                if subscription.source_type == \"polling\":\n                    frame = subscription.frame\n                    \n                    if frame not in polling_groups:\n                        polling_groups[frame] = []\n                    \n                    polling_groups[frame].append(subscription)\n        \n        if not polling_groups:\n            logger.info(\"–ù–µ—Ç polling –∑–∞–¥–∞—á –¥–ª—è –∑–∞–ø—É—Å–∫–∞\")\n            return\n        \n        logger.info(f\"–ó–∞–ø—É—Å–∫ {len(polling_groups)} polling –∑–∞–¥–∞—á...\")\n        \n        self.polling_active = True\n        \n        # –°–æ–∑–¥–∞–µ–º –∑–∞–¥–∞—á—É –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞\n        for frame, subscriptions in polling_groups.items():\n            interval_seconds = self._frame_to_seconds(frame)\n            \n            task_name = f\"polling_{frame}\"\n            task = asyncio.create_task(\n                self._polling_loop(frame, subscriptions, interval_seconds),\n                name=task_name\n            )\n            \n            self.polling_tasks[task_name] = task\n            \n            unique_symbols = set(s.symbol for s in subscriptions)\n            logger.info(\n                f\"   üì° {frame} ({interval_seconds}s): {len(unique_symbols)} –ø–∞—Ä, \"\n                f\"{len(subscriptions)} –ø–æ–¥–ø–∏—Å–æ–∫\"\n            )\n        \n        logger.info(f\"‚úÖ Polling: {len(self.polling_tasks)} –∑–∞–¥–∞—á –∞–∫—Ç–∏–≤–Ω–æ\")\n\n    async def _stop_polling_tasks(self):\n        \"\"\"–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö polling –∑–∞–¥–∞—á\"\"\"\n        \n        self.polling_active = False\n        \n        for task_name, task in self.polling_tasks.items():\n            if not task.done():\n                task.cancel()\n                try:\n                    await task\n                except asyncio.CancelledError:\n                    pass\n                    \n        self.polling_tasks.clear()\n        self.last_poll_times.clear()\n        \n        logger.info(\"‚úÖ –í—Å–µ polling –∑–∞–¥–∞—á–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã\")\n\n    async def _polling_loop(\n        self, \n        frame: str, \n        subscriptions: List[SubscriptionRequest], \n        interval_seconds: int\n    ):\n        \"\"\"–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª polling –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞\"\"\"\n        \n        while self.polling_active:\n            try:\n                # Rate limiting\n                now = time.time()\n                last_poll = self.last_poll_times.get(frame, 0)\n                \n                if now - last_poll < interval_seconds:\n                    await asyncio.sleep(interval_seconds - (now - last_poll))\n                \n                # –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞\n                unique_symbols = set(s.symbol for s in subscriptions)\n                \n                # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö —Å–∏–º–≤–æ–ª–æ–≤\n                for symbol in unique_symbols:\n                    try:\n                        ticker = await self.rest_client.get_ticker(\n                            category=self.market_category,\n                            symbol=symbol\n                        )\n                        \n                        if ticker:\n                            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ Kline\n                            kline = self._ticker_to_kline(ticker)\n                            \n                            # –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n                            await self._distribute_polling_data(symbol, frame, kline, subscriptions)\n                            \n                    except Exception as e:\n                        logger.error(f\"–û—à–∏–±–∫–∞ polling {symbol} @ {frame}: {e}\")\n                \n                self.last_poll_times[frame] = time.time()\n                \n            except asyncio.CancelledError:\n                break\n            except Exception as e:\n                logger.error(f\"–û—à–∏–±–∫–∞ –≤ polling —Ü–∏–∫–ª–µ {frame}: {e}\")\n                await asyncio.sleep(5)\n\n    async def _distribute_polling_data(\n        self, \n        symbol: str, \n        frame: str, \n        kline: Kline, \n        subscriptions: List[SubscriptionRequest]\n    ):\n        \"\"\"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ polling –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º\"\"\"\n        \n        # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ symbol+frame\n        matching_subscriptions = [\n            s for s in subscriptions \n            if s.symbol == symbol and s.frame == frame\n        ]\n        \n        # –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏\n        for subscription in matching_subscriptions:\n            try:\n                await subscription.callback(symbol, kline)\n            except Exception as e:\n                logger.error(\n                    f\"–û—à–∏–±–∫–∞ polling callback [{subscription.strategy_name}] {symbol}: {e}\"\n                )\n\n    async def _activate_new_subscriptions(self, strategy_name: str):\n        \"\"\"–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (–µ—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —É–∂–µ –∑–∞–ø—É—â–µ–Ω)\"\"\"\n        \n        logger.info(f\"[{strategy_name}] üîÑ –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–æ–∫ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏...\")\n        \n        # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º WebSocket –ø–æ–¥–ø–∏—Å–∫–∏\n        await self._start_websocket_subscriptions()\n        \n        # Polling –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º —Ü–∏–∫–ª–µ\n        logger.info(f\"[{strategy_name}] ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã\")\n\n    @staticmethod\n    def _ticker_to_kline(ticker_data: dict) -> Kline:\n        \"\"\"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è ticker –≤ Kline –æ–±—ä–µ–∫—Ç\"\"\"\n        \n        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ API\n        if 'result' in ticker_data and 'list' in ticker_data['result']:\n            ticker = ticker_data['result']['list'][0]\n        else:\n            ticker = ticker_data\n            \n        last_price = float(ticker.get(\"lastPrice\", 0))\n        high_price = float(ticker.get(\"highPrice24h\", last_price))\n        low_price = float(ticker.get(\"lowPrice24h\", last_price))\n        volume = float(ticker.get(\"volume24h\", 0))\n\n        return Kline(\n            timestamp=int(time.time() * 1000),\n            open=last_price,  # –î–ª—è polling –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Ü–µ–Ω—É\n            high=high_price,\n            low=low_price,\n            close=last_price,\n            volume=volume,\n            confirm=True  # –í—Å–µ–≥–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–∞—è –¥–ª—è polling\n        )\n\n    @staticmethod\n    def _frame_to_seconds(frame: str) -> int:\n        \"\"\"–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è frame –≤ —Å–µ–∫—É–Ω–¥—ã\"\"\"\n        if frame.endswith(\"s\"):\n            return int(frame[:-1])\n        if frame == \"D\":\n            return 86400\n        if frame == \"W\":\n            return 604800\n        if frame == \"M\":\n            return 2592000\n        return int(frame) * 60\n\n    def get_stats(self) -> dict:\n        \"\"\"–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞\"\"\"\n        \n        polling_subs = sum(\n            len([s for s in subs if s.source_type == \"polling\"]) \n            for subs in self.subscriptions.values()\n        )\n        \n        websocket_subs = sum(\n            len([s for s in subs if s.source_type == \"websocket\"]) \n            for subs in self.subscriptions.values()\n        )\n        \n        return {\n            \"registered_strategies\": len(self.registered_strategies),\n            \"total_subscriptions\": len(self.subscriptions),\n            \"polling_subscriptions\": polling_subs,\n            \"websocket_subscriptions\": websocket_subs,\n            \"active_ws_subscriptions\": len(self.active_ws_subscriptions),\n            \"active_polling_tasks\": len(self.polling_tasks),\n            \"is_running\": self.is_running\n        }\n